
apiVersion: apps/v1
kind: Deployment
metadata:
 name: mysql
 namespace: roboshop
 labels:
  component: mysql
  project: roboshop
  tier: database
spec:
 replicas: 1
 selector:
  matchLabels:
    component: mysql
    project: roboshop
    tier: database
 template:
  metadata:
    labels:
      component: mysql
      project: roboshop
      tier: database
  spec:
    serviceAccountName: roboshop-mysql-secret-reader
    volumes:
    - name: mysql-secret
      emptyDir: {}
    containers:
    - name: mysql
      image: ajayvallala/mysql:v2
      imagePullPolicy: Always
      volumeMounts:
      - name: mysql-secret
        mountPath: /tmp
    initContainers:
    - name: fetch-secret
      image: amazon/aws-cli
      command:
         - sh
         - -c
         - |
            aws secretsmanager get-secret-value --secret-id roboshop/mysql/secret --query SecretString --output text | jq -r .MYSQL_ROOT_PASSWORD > /tmp/mysql_root_password.txt
      volumeMounts:
      - name: mysql-secret
        mountPath: /tmp
---
 
apiVersion: v1
kind: Service
metadata:
 name: mysql
 namespace: roboshop
 labels:
  component: mysql
  project: roboshop
  tier: database
spec:
 selector:
  component: mysql
  project: roboshop
  tier: database
 ports:
 - protocol: TCP
   port: 3306
   targetPort: 3306


      